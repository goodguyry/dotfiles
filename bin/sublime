#!/bin/bash

##
# Install Sublime Text packages and settings.
##

# Source utils.
DOTFILES_DIRECTORY="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )";
source "${DOTFILES_DIRECTORY}/var/helpers.sh";

# Set Sublime Text settings directory.
if $IS_MACOS; then
  ST_PACKAGES="${HOME}/Library/Application Support/Sublime Text/Packages";
  SM_PACKAGES="${HOME}/Library/Application Support/Sublime Merge/Packages";
else
  ST_PACKAGES="${HOME}/.config/sublime-text-3/Packages";
  SM_PACKAGES="${HOME}/.config/sublime-merge/Packages";
fi

# Create the directory path if it doesn't exist.
[[ ! -d "${SUBLIME_PACKAGES}/User" ]] && mkdir -p "${SUBLIME_PACKAGES}/User";

# Clone a Sublime Text 3 package repo to Packages directory.
function add_sublime_package_from_github() {
  local REPO="${1}"
  local PACKAGE="${2}";
  if [[ ! -d "${ST_PACKAGES}/${PACKAGE}" ]]; then
    log_info "Cloning ${PACKAGE}";
    git clone "https://github.com/${REPO}" "${ST_PACKAGES}/${PACKAGE}"  &> /dev/null;
    [[ $? ]] && log_success "${PACKAGE} installed."
  else
    log_info "${PACKAGE} already exists...";
  fi;
}

# Clone packages.
log_info 'Installing Package Control...';

subl --command "install_package_control";

declare -a packages=(
  'A File Icon'
  'AlignTab'
  'ayu'
  'Babel'
  'CSS3'
  'DocBlockr'
  'EditorConfig'
  'JavaScript Completions'
  'JS Template String Converter'
  'Liquid'
  'MarkdownEditing'
  'MarkdownPreview'
  'Project Specific Syntax Settings'
  'Sass'
  'SassSolution'
  'SidebarEnhancements'
  'SublimeLinter ESLint'
  'SublimeLinter PHPCS'
  'SublimeLinter'
  'Syntax Highlighting for Sass'
  'Terminal'
);

printf -v joined_packages '%s,' "${packages[@]}";

printf "\n";
log_info "Use \"Package Control: Advanced Install Package\" from the command palette";
log_header "${joined_packages%,}";
printf "\n";

# Git
add_sublime_package_from_github 'kemayo/sublime-text-git.git' 'Git';

# Checkout the `SublimeText2` branch for the SCSS package.
cd "${ST_PACKAGES}/SCSS" && git checkout SublimeText2 && cd - &>/dev/null;

log_success 'Sublime Text packages installed.'

# Link the Sublime Text settings files into place.
for ST_SETTINGS_FILE in etc/sublime-text/*; do
  [[ -f "${ST_SETTINGS_FILE}" ]] && set_file "${ST_SETTINGS_FILE}" "${ST_PACKAGES}/User/";
done;

[[ $? ]] && log_success 'Sublime Text settings done.'

# Link the Sublime Merge settings files into place.
for SM_SETTINGS_FILE in etc/sublime-merge/*; do
  set_file "${SM_SETTINGS_FILE}" "${SM_PACKAGES}/User/";
done;

[[ $? ]] && log_success 'Sublime Merge settings done.'
